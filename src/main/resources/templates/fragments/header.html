<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" xmlns:ì‚¬ìš©ìëª…="http://www.w3.org/1999/xhtml">
<th:block th:fragment="headerFragment">
    <head>
        <title>Board List</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link rel="stylesheet" th:href="@{/css/header.css}">
        <link rel="stylesheet" th:href="@{/css/content.css}">
        <link rel="stylesheet" th:href="@{/css/common.css}">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <style>
            /* ì•Œë¦¼ íŒì—…ì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
            .notification {
                 width:250px;
            }
            .notification-popup {
                background-color: white;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                padding: 20px;
                max-width: 400px;
                text-align: center;
                display: none;
                position: absolute;
                z-index: 1000;
                top:5%;
            }
            .notification-popup h2 {
                margin-top: 0;
            }

        .notification h2 {
            margin-top: 0;
        }
        .notification ul {
            list-style-type: none;
            padding: 0;
        }
        .notification li {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .notification li:hover {
            background-color: #f9f9f9;
        }
         .notification .notification-nametext {
           font-weight: bold;
           font-size : 15px;
        }
        .notification .notification-text {
            flex: 1; /* í…ìŠ¤íŠ¸ê°€ ë„˜ì¹  ê²½ìš° ìë™ìœ¼ë¡œ ì¤„ë°”ê¿ˆ ë˜ë„ë¡ ì„¤ì • */
        }
       .notification .notification-time {
            color: #999;
            font-size: 12px;
            margin-top: 5px; /* ì‹œê°„ê³¼ í…ìŠ¤íŠ¸ ì‚¬ì´ì˜ ê°„ê²© ì¶”ê°€ */
        }

        </style>
    </head>
    <body>
    <!-- ììœ /ìµëª… ê²Œì‹œíŒ -->
        <div class="header">
            <div class="header_menu">
                <ul >
                    <li>
                        <a href="/"> ììœ ê²Œì‹œíŒ</a>
                    </li>
                </ul>
            </div>
        <!-- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ -->
            <div class="header_auth">
                <a sec:authorize="isAnonymous" href="/login">ë¡œê·¸ì¸</a>
                <div sec:authorize="isAuthenticated()" style="display:flex;">
                    <button class="emoji-button" id="notificationBtn" style="border:none; background-color:#FFFFFF;">
                        ğŸ””
                    </button>
                    <!-- ìƒˆë¡œìš´ ì•Œë¦¼ ë©”ì„¸ì§€ í‘œì‹œ -->
                    <div id="notificationIndicator" style="
                            position: absolute;
                            width: 15px;
                            height: 15px;
                            background-color: red;
                            color: white;
                            border-radius: 50%;
                            display: none;
                            justify-content: center;
                            align-items: center;
                            font-size: 14px;
                      ">!</div>
                    <!-- Oauth2.0ìœ¼ë¡œ ë¡œê·¸ì¸í•œ ê²½ìš° -->
                    <div th:if="${#authentication != null and #authentication.principal instanceof T(org.springframework.security.oauth2.core.user.OAuth2User)}">
                        <span class="bold" th:if="${#authentication.principal.attributes['name'] != null}"
                              th:text="${#authentication.principal.attributes['name']}"></span>
                        <span class="bold" th:if="${#authentication.principal.attributes['properties']?.nickname != null}"
                              th:text="${#authentication.principal.attributes['properties']?.nickname}">
                        </span>
                        <span>ë‹˜ ì•ˆë…•í•˜ì„¸ìš”</span>
                    </div>
                    <!-- Spring Security ìœ¼ë¡œ ì§ì ‘ ë¡œê·¸ì¸í•œ ê²½ìš° -->
                    <div th:if="${#authentication != null and #authentication.principal instanceof T(org.springframework.security.core.userdetails.UserDetails)}">

                        <span class="bold" th:if="${#authentication.principal.usernick != null}"
                              th:text="${#authentication.principal.usernick}"></span>
                        <span>ë‹˜ ì•ˆë…•í•˜ì„¸ìš”</span>
                    </div>
                    <div id="notificationPopup" class="notification-popup">
                        <h2>ì•Œë¦¼</h2>
                        <div class="notification" style="width:200px">
                            <ul id="notificationList">
                                <!-- ì—¬ê¸°ì— APIì—ì„œ ê°€ì ¸ì˜¨ ì•Œë¦¼ ë°ì´í„°ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ì˜ˆì • -->
                            </ul>

                        </div>
                    </div>
                </div>
                <a sec:authorize="isAnonymous" href="/join">íšŒì›ê°€ì…</a>
                <a sec:authorize="isAuthenticated()" href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </body>
    <script>

       const notificationButton = document.getElementById('notificationBtn');
       const popup = document.getElementById('notificationPopup');
       const closeButton = document.getElementById('closePopup');
       if(notificationButton != null) {
       notificationButton.addEventListener('click', function() {
           $.ajax({
                            type:'GET',
                            contentType:'application/json',
                            url:'/notifications/list',
                            success:function(data){
                               const notificationList = document.getElementById('notificationList');
                               notificationList.innerHTML = '';
                               data.result.forEach(notification => {

                               const li = document.createElement('li');
                               li.classList.add('notification-item');

                               const a = document.createElement('a');
                               li.appendChild(a);
                               a.href= '/article/detail/' + notification.articleId


                               // ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ì¶”ê°€
                               const nickNameText = document.createElement('p');
                               nickNameText.classList.add('notification-nametext');
                               nickNameText.textContent = notification.writerNickname;
                               a.appendChild(nickNameText);


                               // ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ì¶”ê°€
                               const articleTtiletext = document.createElement('p');
                               articleTtiletext.classList.add('notification-text');
                               articleTtiletext.textContent = "ë‹˜ì´ " + "ê¸€ ì œëª© : " + '"' + notification.articleTitle + '"'  + " ì— ë‹µë³€ì„ ë‹¬ì•˜ìŠµë‹ˆë‹¤.";
                               a.appendChild(articleTtiletext);


                               // ì‹œê°„ ì¶”ê°€
                               const time = document.createElement('p');
                               time.classList.add('notification-time');
                               time.textContent = notification.commentCreatetime;
                               a.appendChild(time);

                               // ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                               notificationList.appendChild(li);
                               });
                            },
                            error: function(e) {
                                console.log(e);
                            }
                   });
          popup.style.display = 'block';
          notificationIndicator.style.display = 'none';
      });


      document.addEventListener('click', function(event) {
           if (!popup.contains(event.target) && event.target !== notificationButton) {
               popup.style.display = 'none';
           }
       });

       // ì „ì—­ ë³€ìˆ˜ë¡œ eventSourceë¥¼ ì„ ì–¸
         let eventSource = null;

         // êµ¬ë… í•¨ìˆ˜
         function subscribeToNotifications() {

            if (eventSource !== null) {
                 return;
                }

           // ìƒˆë¡œìš´ EventSource ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê³  êµ¬ë… ì‹œì‘
              eventSource = new EventSource('/notifications');
              const notificationIndicator = document.getElementById('notificationIndicator');
               // ë©”ì‹œì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
              eventSource.addEventListener('notification', function(event) {
              console.log(event.data);
               // ìƒˆë¡œìš´ ì•Œë¦¼ì„ ìˆ˜ì‹ í•˜ë©´ ëŠë‚Œí‘œë¥¼ í‘œì‹œ
               if(event.data != "ì—°ê²°ì™„ë£Œ")
               {
                notificationIndicator.style.display = 'flex';
                console.log('ìƒˆ ì•Œë¦¼:', event.data);
                }
              });

              // ì˜¤ë¥˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
              eventSource.addEventListener('error', function(event) {
                console.error('EventSource ì—ëŸ¬:', event);
                // ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ eventSourceë¥¼ ë‹«ê³  nullë¡œ ì´ˆê¸°í™”
                eventSource.close();
                eventSource = null;
              });

         }


         // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ êµ¬ë… (ì›í•˜ëŠ” ê²½ìš°)
         window.onload = function() {
          // ì„¸ì…˜ ìƒíƒœ í™•ì¸ ì—¬ë¶€
               let ssesionStatus = 0
               $.ajax({
                        type:'get',
                        contentType:'application/json',
                        url:'/api/session',
                        success:function(data){
                           ssesionStatus = data;
                           if(ssesionStatus == 1)
                               {
                                subscribeToNotifications();
                               }
                        },
                        error: function(e) {
                            console.log(e);
                        }
               });



         };
   }
    </script>
</th:block>
</html>
