<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" xmlns:ì‚¬ìš©ìëª…="http://www.w3.org/1999/xhtml">
<th:block th:fragment="headerFragment">
    <head>
        <title>Board List</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <meta name="_csrf" th:content="${_csrf.token}"/>
        <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link rel="stylesheet" th:href="@{/css/header.css}">
        <link rel="stylesheet" th:href="@{/css/content.css}">
        <link rel="stylesheet" th:href="@{/css/common.css}">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    </head>
    <body>
    <!-- ììœ /ìµëª… ê²Œì‹œíŒ -->
        <div class="header">
            <div class="header_menu">
                <ul >
                    <li>
                        <a href="/"> ììœ ê²Œì‹œíŒ</a>
                    </li>
                </ul>
            </div>
        <!-- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ -->
            <div class="header_auth">
                <a sec:authorize="isAnonymous" href="/login">ë¡œê·¸ì¸</a>
                <div sec:authorize="isAuthenticated()" style="display:flex;">
                    <button class="emoji-button" id="notificationBtn" style="border:none; background-color:#FFFFFF;">
                        ğŸ””
                    </button>
                    <!-- ìƒˆë¡œìš´ ì•Œë¦¼ ë©”ì„¸ì§€ í‘œì‹œ -->
                    <div id="notificationIndicator" style="
                            position: absolute;
                            width: 15px;
                            height: 15px;
                            background-color: red;
                            color: white;
                            border-radius: 50%;
                            display: none;
                            justify-content: center;
                            align-items: center;
                            font-size: 14px;
                      ">!</div>
                    <!-- Spring Security ìœ¼ë¡œ ì§ì ‘ ë¡œê·¸ì¸í•œ ê²½ìš° -->
                    <div th:if="${#authentication != null}">
                        <a href="javascript:;">
                        <span class="bold" id="usernick" th:if="${#authentication.principal.usernick != null}"
                              th:text="${#authentication.principal.usernick}"></span>
                        </a>
                        <div id="my_page" class="list-group" style="position:absolute; display:none;">
                            <ul>
                                <a th:href="@{/mypage(userid=${#authentication.principal.id},type=article_list)}" class="list-group-item list-group-item-action">
                                   ë§ˆì´í˜ì´ì§€
                                </a>
                                <a href="/note" class="list-group-item list-group-item-action">
                                    ìª½ì§€
                                </a>
                            </ul>
                        </div>
                        <span>ë‹˜ ì•ˆë…•í•˜ì„¸ìš”</span>
                    </div>

                    <div id="notificationPopup" class="notification-popup">
                        <h2 style="width:250px; padding:10px; border: 1px solid;">ì•Œë¦¼</h2>
                        <div class="notification" id="notification">
                            <ul id="notificationList">
                                <!-- ì—¬ê¸°ì— APIì—ì„œ ê°€ì ¸ì˜¨ ì•Œë¦¼ ë°ì´í„°ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ì˜ˆì • -->
                            </ul>
                            <div id="noFeedList" style="
                                        margin-top: 200px;
                                        display:none;
                                    ">
                                <span>ë°›ì€ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</span>
                            </div>

                        </div>
                    </div>
                </div>
                <a sec:authorize="isAnonymous" href="/join">íšŒì›ê°€ì…</a>
                <form sec:authorize="isAuthenticated()" method="post" th:action="@{/logout}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="submit" style=" width: 70px; font-size: 12px;" class="btn btn-secondary" value="ë¡œê·¸ì•„ì›ƒ" />
                </form>

            </div>
        </div>
    </body>
    <script>
        let pageNumber = 0;
        let pageLast = true;
        const header_token = $("meta[name='_csrf']").attr("content")
        const header_csrf = $("meta[name='_csrf_header']").attr("content");



        $(document).ready(function() {
            if($('#usernick').length) {
                $('#usernick').on('click', function() {
                    $('#my_page').show();
                });
            }
        });


        function addNotificaionList(pageNumber) {

                       $.ajax({
                            type:'GET',
                            contentType:'application/json',
                            url:'/api/notifications/get?page=' + pageNumber,
                            success:function(data){
                               const $notificationList = $('#notificationList');
                               const $noFeedList = $('#noFeedList');

                               if(data.count == 0) {
                                   $noFeedList.show();
                                   pageNumber = 0;
                               }
                               else {
                                   pageNumber = data.number;
                                   pageLast = data.last;
                                   $noFeedList.hide();
                                   data.content.forEach(notification => {
                                       const $li = $('<li>',{ class:'notification-item' });
                                       const $a = $('<a>', { href: '/article/detail/' + notification.articleId });

                                       // ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ì¶”ê°€
                                       const $nickNameText = $('<p>',{ class: 'notification-nametext',text: notification.writerNickname});

                                       // ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ì¶”ê°€
                                       const $articleTitleText = $('<p>',{ class: 'notification-text',text : "ë‹˜ì´ " + "ê¸€ ì œëª© : " + '"' + notification.articleTitle + '"'  + " ì— ë‹µë³€ì„ ë‹¬ì•˜ìŠµë‹ˆë‹¤." });

                                       // ì‹œê°„ ì¶”ê°€
                                       const $time = $('<p>',{class: 'notification-time',text: notification.commentCreatetime});
                                       $a.append($nickNameText,$articleTitleText,$time);

                                       $li.append($a);
                                       // ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                                       $notificationList.append($li);
                                   });
                               }
                            },
                            beforeSend : function(xhr) {
                                xhr.setRequestHeader(header_csrf, header_token);
                            },
                            error: function(e) {
                                console.log(e);
                            }
                   });

           }



       const $notificationButton = $('#notificationBtn');
       const $popup = $('#notificationPopup');
       const $closeButton = $('#closePopup');
       if($notificationButton != null) {
            const $notificationElement = $('#notification'); // ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ìš”ì†Œì˜ IDë¥¼ ê°€ì ¸ì˜´
             $notificationElement.on('scroll', function() {
                     setTimeout(function() {
                       const scrollTop = $notificationElement.scrollTop();
                    const scrollHeight = $notificationElement[0].scrollHeight; // jQuery ê°ì²´ì—ì„œ ì›ë³¸ DOM ìš”ì†Œë¥¼ ê°€ì ¸ì™€ì„œ ì‚¬ìš©
                    const clientHeight = $notificationElement[0].clientHeight;

                        if (scrollTop + clientHeight >= scrollHeight) {
                          if(pageLast == false)
                          {
                             console.log('ìŠ¤í¬ë¡¤ì´ ëì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.');
                             addNotificaionList(pageNumber+1)
                           }
                        }
             }, 2000);
           }); // 200ms ë‚´ì— ë‹¤ì‹œ í˜¸ì¶œë˜ì§€ ì•Šë„ë¡ ë””ë°”ìš´ìŠ¤ ì„¤ì •


        $notificationButton.on('click', function() {
          const $notificationList = $('#notificationList');
          $notificationList.innerHTML = '';
          $popup.show()
          $('#notificationIndicator').hide();
          addNotificaionList(pageNumber)
        });


         document.addEventListener('click', function(event) {
               if (!$popup.is(event.target) && !$notificationButton.is(event.target) && !$popup.has(event.target).length) {
                   const $notificationList = $('#notificationList');
                   $notificationList.text('');
                   $popup.hide();
               }

               if(!$("#my_page").has(event.target).length && !$("#usernick").is(event.target)) {
                $("#my_page").hide();
               }
           });




         // êµ¬ë… í•¨ìˆ˜
         function subscribeToNotifications() {

           // ìƒˆë¡œìš´ EventSource ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê³  êµ¬ë… ì‹œì‘
              eventSource = new EventSource('/api/notification/subscribe');
              const $notificationIndicator = $('#notificationIndicator');
               // ë©”ì‹œì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
              eventSource.addEventListener('notification', function(event) {
               // ìƒˆë¡œìš´ ì•Œë¦¼ì„ ìˆ˜ì‹ í•˜ë©´ ëŠë‚Œí‘œë¥¼ í‘œì‹œ
               if(event.data != "ì—°ê²°ì™„ë£Œ")
               {
                $notificationIndicator.css('display','flex');
                console.log('ìƒˆ ì•Œë¦¼:', event.data);
                }
              });

              // ì˜¤ë¥˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
              eventSource.addEventListener('error', function(event) {
                console.error('EventSource ì—ëŸ¬:', event);
                // ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ eventSourceë¥¼ ë‹«ê³  nullë¡œ ì´ˆê¸°í™”
                eventSource.close();
                eventSource = null;
              });

         }


         // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ êµ¬ë… (ì›í•˜ëŠ” ê²½ìš°)
         window.onload = function() {
          // ì„¸ì…˜ ìƒíƒœ í™•ì¸ ì—¬ë¶€
               let ssesionStatus = 0
               $.ajax({
                        type:'get',
                        url:'/api/session/check',
                        success:function(data){
                           ssesionStatus = data;
                           if(ssesionStatus)
                               {
                                subscribeToNotifications();
                               }
                        },
                        error: function(e) {
                            console.log(e);
                        }
               });

         };
   }
    </script>
</th:block>
</html>
