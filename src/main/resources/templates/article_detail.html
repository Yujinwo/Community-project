<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.w3.org/1999/xhtml" layout:decorate="layout/default_layout">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<th:block layout:fragment="content">
    <!-- ì‚­ì œ í™•ì¸ ì°½-->
    <div class="modal">
        <div class="modal_popup">
            <h5> ì‚­ì œë¥¼ ì›í•˜ì‹œë©´ ì˜ˆë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”. </h5></br>
            <!-- ì˜ˆ ë²„íŠ¼ -->
            <button type="button" onclick="articleDeleteYes(this.getAttribute('data-article-id'))" th:attr="data-article-id=${article.id}" class="close_btn">ì˜ˆ</button>
            <!-- ì•„ë‹ˆìš” ë²„íŠ¼ -->
            <button type="button" onclick="articleDeleteNo()" class="close_btn">ì•„ë‹ˆìš”</button>
        </div>
    </div>
    <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ -->
    <div class="article_button" sec:authorize="isAuthenticated()">
        <!-- ìˆ˜ì • ë²„íŠ¼ -->
        <button th:if="${article.member.id == @authenticationUtil.getCurrentMember()?.id}" class="button_blue btn btn-primary" th:onclick="|location.href='@{/articles/{id}/edit(id=${article.id})}'|">ìˆ˜ì •í•˜ê¸°</button>
        <!-- ì‚­ì œ ë²„íŠ¼ -->
        <button th:if="${article.member.id == @authenticationUtil.getCurrentMember()?.id}" onclick="articleDelete()" class="button_red btn btn-danger" >ì‚­ì œí•˜ê¸°</button>
    </div>
    <!-- ê¸€ ì •ë³´ -->
    <div class="article">
        <!-- ê¸€ ì œëª© -->
        <h2 class="bold" th:text="${article.title}" ></h2><br>
        <!-- ê¸€ ë‚´ìš© -->
        <div class="detail_content_area" th:text="${article.content}"></div></br>
        <!-- ê¸€ ì‘ì„±ì -->
        <a href="javascript:;">
        <span class="article_addtext bold" id="article_addtext_writer" th:text="${article.member.usernick}"></span>
        </a>
        <span> Â· </span>
        <!-- ê¸€ ì‘ì„± ì‹œê°„ -->
        <span class="article_addtext" th:text="${@timeUtil.calculateTimeAgo(article.createdDate)}"></span>
        <span> Â· </span>
        <!-- ê¸€ ì¡°íšŒìˆ˜  -->
        <span class="article_addtext" th:text="${article.viewcount}"></span></br>
        <!-- ìœ ì € ë‹‰ë„¤ì„ ë”ë³´ê¸° ë©”ë‰´ ì°½-->
        <div class="list-group" style="position:absolute; display:none; margin-top:10px" id="noteSend_Window">
            <ul>
                <a th:href="@{/profile(userid=${article.member.id},type=article_list)}" class="list-group-item list-group-item-action">
                    í”„ë¡œí•„
                </a>
                <li sec:authorize="isAuthenticated()">
                    <a href="javascript:;" class="list-group-item list-group-item-action" id="open-message-btn">ìª½ì§€ ë³´ë‚´ê¸°</a>
                </li>
            </ul>
        </div>
        <!-- íƒœê·¸ -->
        <div th:if="${article.tagConents.size() != 0}"  class="detail_tag-container">
            <ul id="tag-list" >
                <li th:each="tag : ${article.tagConents}">
                    <span th:text="'#' + ${tag}" class="tag-text"></span>
                </li>
            </ul>
        </div>
        <!-- ì¦ê²¨ì°¾ê¸° ë²„íŠ¼ -->
        <div style="display: flex; justify-content:end;" sec:authorize="isAuthenticated()">
            <a href="javascript:;" >
                <span th:classappend=" ${bookmark_state} ? 'active'" class="bookmark" id="bookmark"></span>
            </a>
        </div>
    </div>
    <!-- ê¸€ ì´ë¯¸ì§€-->
    <div class="article_images" th:if="${article.imageUrls.size() != 0}">
        <label class="form-label">ì´ë¯¸ì§€</label>
        <div th:each="imageUrl : ${article.imageUrls}">
            <img th:src="@{'https://imagetest.s3.ap-northeast-2.amazonaws.com/' + ${imageUrl}}" width="750px" height="375px">
        </div>
    </div>

    <!-- ëŒ“ê¸€ ê°¯ìˆ˜ -->
    <div class="comment_count ">
        ğŸ’¬ ëŒ“ê¸€
        <b class="bold" th:text="${article.commentcount}"></b>
        ê°œ
    </div>
    <!-- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ -->
    <div th:if="${endPage != 0}" th:id="'comment_'+${comment.id}" th:each="comment : ${comment}" class="article_comments" th:style="${comment.redepth != 0 ? ' padding-left: ' + comment.redepth * 40 + 'px' : ''} ">
        <!-- ëŒ“ê¸€ì´ ì‚­ì œ ìƒíƒœê°€ ì•„ë‹Œ ê²½ìš° ëŒ“ê¸€ í‘œì‹œ -->
        <div class="comment"  th:if="${comment.deleted == false }">
            <span th:if="${comment.parent != null}" class="bold"> â†ª </span>
            <!-- ëŒ“ê¸€ ì‘ì„±ì -->
            <span class="bold" th:text="${comment.member.usernick}"></span>
            <span> Â· </span>
            <!-- ëŒ“ê¸€ ì‘ì„± ì‹œê°„ -->
            <span th:text="${@timeUtil.calculateTimeAgo(comment.createdDate)}"></span>
            <span> Â· </span>
            <!-- ëŒ“ê¸€ ìˆ˜ì • ë²„íŠ¼-->
            <button sec:authorize="isAuthenticated()" class="edit-button comment_update" th:if="${comment.member.id == @authenticationUtil.getCurrentMember()?.id}" th:id="${comment.id}">ìˆ˜ì •</button>
            <!-- ëŒ“ê¸€ ì‚­ì œ ë²„íŠ¼-->
            <span  sec:authorize="isAuthenticated()" class="comment_delete">
                <button onclick="deleteComment(this.getAttribute('data-comment-id'))" th:attr="data-comment-id=${comment.id}" th:if="${comment.member.id == @authenticationUtil.getCurrentMember()?.id}">ì‚­ì œ</button>
            </span>
            <div class="edit-input" style="display: none;">
                <input style="height:100px;" type="text" class="edit-text form-control" />
                <button class="save-button comment_update" style="color: #565e64;" th:id="${comment.id}">ì €ì¥</button>
                <button class="cancel-button comment_update" style="color: #565e64;" th:id="${comment.id}">ì·¨ì†Œ</button>
            </div>

            <!-- ê¹Šì´ í‘œì‹œ -->
            <div th:style="${comment.redepth != 0 ? 'padding-left: ' + comment.redepth * 10 + 'px; margin-top: 10px;' + 'display:flex;' : 'margin-top: 10px;'}">
                <!-- ìƒìœ„ ëŒ“ê¸€ ì‘ì„±ì -->
                <span class="parent-comment-text" th:if="${comment.parent != null}" style="color:#6c757d; margin:0 10px;" th:text="${comment.parent.member.usernick}"> </span>
                <!-- ëŒ€ëŒ“ê¸€ ë‚´ìš© -->
                <div class="comment-text" th:text="${comment.content}"></div>
            </div>
            <!-- ë‹µê¸€ ë‹¬ê¸° ë²„íŠ¼ -->
            <div th:style="${comment.redepth != 0 ? ' padding-left: ' + comment.redepth * 20 + 'px' : ''} ">
                <button style="color: #565e64;" class="reply_button" th:id="'reply_button_' + ${comment.id}" onclick="replyButton(this.getAttribute('data-comment-id'))" th:attr="data-comment-id=${comment.id}">ë‹µê¸€ ë‹¬ê¸°</button>
            </div>
        </div>
        <!-- ëŒ“ê¸€ì´ ì‚­ì œ ìƒíƒœì¸ ê²½ìš° ì‚­ì œëœ ëŒ“ê¸€ë¡œ í‘œì‹œ -->
        <div th:if="${comment.deleted == true}">
            <div> ì‚­ì œëœ ëŒ“ê¸€ ì…ë‹ˆë‹¤!</div>
        </div>

        <!-- ë‹µê¸€ ì“°ê¸° form -->
        <div class="reply-form" th:id="'reply_form_' + ${comment.id}" style="display: none;">
            <div class="comment_write">
                <h2>ë‹µê¸€ì“°ê¸°</h2>
                <!-- ê¶Œí•œì´ ìˆì„ì‹œ -->
                <div sec:authorize="isAuthenticated()">
                    <!-- ëŒ€ëŒ“ê¸€ ì…ë ¥ ì°½ -->
                    <textarea type="text" th:id="'reply_content' + ${comment.id}" ></textarea>
                    <!-- ëŒ€ëŒ“ê¸€ ë“±ë¡ ë²„íŠ¼ -->
                    <button onclick="replySubmit(this.getAttribute('data-article-id'),this.getAttribute('data-comment-id'))" th:attr="data-article-id=${article.id},data-comment-id=${comment.id}" class="reply-submit btn btn-primary">ë“±ë¡</button>
                </div>
                <!-- ê¶Œí•œì´ ì—†ì„ì‹œ ë¡œê·¸ì¸ ë¬¸êµ¬ í‘œì‹œ -->
                <div sec:authorize="isAnonymous()" class="disabled">
                    <textarea type="text" >ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”</textarea>
                    <button class="btn btn-primary">ë“±ë¡</button>
                </div>
            </div>
        </div>

    </div>
    <!-- ëŒ“ê¸€ í˜ì´ì§€ ë¦¬ìŠ¤íŠ¸ -->
    <div th:if="${endPage != 0}" class="paging_list">
        <ul class="pagination">
            <li class="page-item">
                <!-- ì´ì „ ë§í¬ ìˆì„ì‹œ í™œì„±í™” ì—†ì„ì‹œ ë¹„ í™œì„±í™” -->
                <a class="page-link" th:classappend=" ${!pageable.previous} ? 'disabled' " th:href="${!pageable.first} ? @{/articles/{id}(id=${article.id},page=${pageable.number})}"> ì´ì „ </a>
            </li>
            <!-- ì‹œì‘í˜ì´ì§€ -> ë í˜ì´ì§€ ê¹Œì§€ í˜ì´ì§€ ì¶œë ¥ -->
            <span th:each="page: ${#numbers.sequence(startPage, endPage)}">
                <li class="page-item">
                    <!-- í˜„ì¬í˜ì´ì§€ëŠ” ë§í¬ ì—†ì´ ìˆ«ìë§Œ -->
                     <a class="page-link active" th:if="${page == pageable.number + 1}" href="javascript:;" th:text="${page}"></a>
                    <!-- í˜„ì¬í˜ì´ì§€ ë§í¬ X, ë‹¤ë¥¸ í˜ì´ì§€ë²ˆí˜¸ì—ëŠ” ë§í¬ë¥¼ ë³´ì—¬ì¤€ë‹¤ -->
                     <a class="page-link" th:unless="${page == pageable.number + 1}" th:href="@{/articles/{id}(id=${article.id},page=${page})}" th:text="${page}"></a>
                </li>
            </span>
            <li class="page-item">
                <!-- ë‹¤ìŒ ë§í¬ ìˆì„ì‹œ í™œì„±í™” ì—†ì„ì‹œ ë¹„ í™œì„±í™” -->
                <a class="page-link" th:classappend=" ${!pageable.next} ? 'disabled' "  th:href="${pageable.last} ? '#' : @{/articles/{id}(id=${article.id},page=${pageable.number + 2})}"> ë‹¤ìŒ </a>
            </li>
        </ul>
    </div>

    <!-- ëŒ“ê¸€ ì“°ê¸° form -->
    <div class="comment_write">
            <h2>ëŒ“ê¸€ì“°ê¸°</h2>
            <!-- ê¶Œí•œì´ ìˆì„ì‹œ -->
            <div sec:authorize="isAuthenticated()">
                <!-- ëŒ“ê¸€ ì…ë ¥ ì°½ -->
                <textarea type="text" id="content" ></textarea>
                <!-- ëŒ“ê¸€ ë“±ë¡ ë²„íŠ¼ -->
                <button onclick="commentSubmit(this.getAttribute('data-article-id'))" th:attr="data-article-id=${article.id}" class="btn btn-primary" >ë“±ë¡</button>
            </div>
           <!-- ê¶Œí•œì´ ì—†ì„ì‹œ ë¡œê·¸ì¸ ë¬¸êµ¬ í‘œì‹œ -->
             <div sec:authorize="isAnonymous()" class="disabled">
                <textarea type="text" >ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”</textarea>
                 <button class="btn btn-primary">ë“±ë¡</button>
            </div>
    </div>
    <script th:inline="javascript">
                 // ì˜ˆ/ì•„ë‹ˆì˜¤ íŒì—…ì°½
                 const modal = $(document).find('.modal');
                 const articleId = [[${article.id}]];


                 $(document).ready(function() {

                 // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                    $('.edit-button').on('click', function() {
                        const commentDiv = $(this).closest('.article_comments');
                        const commentText = commentDiv.find('.comment-text');
                        const parentcommentText = commentDiv.find('.parent-comment-text');
                        const replyButton = commentDiv.find('.reply_button');
                        const editInput = commentDiv.find('.edit-input');
                        const editText = commentDiv.find('.edit-text');

                        // ìˆ˜ì • ì…ë ¥ì°½ì— í˜„ì¬ ëŒ“ê¸€ ë‚´ìš© ì„¤ì •
                        editText.val(commentText.text());

                        commentText.hide(); // ëŒ“ê¸€ í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸°
                        parentcommentText.hide(); //ìƒìœ„ ëŒ“ê¸€ í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸°
                        replyButton.hide(); // ë‹µê¸€ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                        editInput.show();   // ìˆ˜ì • ì…ë ¥ì°½ í‘œì‹œ
                    });

                       // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                       $('.save-button').on('click', function() {
                        const commentDiv = $(this).closest('.article_comments');
                        const commentText = commentDiv.find('.comment-text');
                        const parentcommentText = commentDiv.find('.parent-comment-text');
                        const replyButton = commentDiv.find('.reply_button');
                        const editText = commentDiv.find('.edit-text');
                        const editInput = commentDiv.find('.edit-input');

                        // ì…ë ¥ì°½ ë‹«ê¸°
                        editInput.hide();

                        // ê¸°ì¡´ ëŒ“ê¸€ í…ìŠ¤íŠ¸ì™€ ë‹µê¸€ ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
                        commentText.show();
                        parentcommentText.show();
                        replyButton.show();
                        updateComment(this.id,editText.val());


                    });

                    // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                    $('.cancel-button').on('click', function() {
                        const commentDiv = $(this).closest('.article_comments');
                        const editInput = commentDiv.find('.edit-input');
                        const commentText = commentDiv.find('.comment-text');
                        const parentcommentText = commentDiv.find('.parent-comment-text');
                        const replyButton = commentDiv.find('.reply_button');

                        // ì…ë ¥ì°½ ë‹«ê¸°
                        editInput.hide();

                        // ê¸°ì¡´ ëŒ“ê¸€ í…ìŠ¤íŠ¸ì™€ ë‹µê¸€ ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
                        commentText.show();
                        parentcommentText.show();
                        replyButton.show();

                    });


                     $("#bookmark").click(function() {
                        var $bookmark = $("#bookmark").toggleClass("active");
                        if($bookmark.hasClass("active")) {
                                 // ì¦ê²¨ì°¾ê¸° ì¶”ê°€
                                 $.ajax({
                                    ã€€ã€€type:'post'
                                    ã€€ã€€, contentType:'application/json'
                                    ã€€ã€€, url: '/api/bookmarks/' + articleId
                                    ã€€ã€€, success: function(data) {
                                    ã€€ã€€}
                                       , beforeSend : function(xhr) {
                                          xhr.setRequestHeader(header, token);
                                       }
                                       , error:function(e) {
                                            alert(e.responseJSON.message);
                                    ã€€ã€€}
                                    });
                        }
                        else {
                                 // ì¦ê²¨ì°¾ê¸° ì‚­ì œ
                                 $.ajax({
                                    ã€€ã€€type:'delete'
                                    ã€€ã€€, contentType:'application/json'
                                    ã€€ã€€, url: '/api/bookmarks/' + articleId
                                    ã€€ã€€, success: function(data) {
                                    ã€€ã€€}
                                        , beforeSend : function(xhr) {
                                          xhr.setRequestHeader(header, token);
                                       }
                                       , error:function(e) {
                                            alert(e.responseJSON.message);
                                    ã€€ã€€}
                                    });



                        }
                     });

                     // ê¸€ ì‘ì„±ì í´ë¦­ì‹œ ë”ë³´ê¸° ë©”ë‰´ì°½
                     $('#article_addtext_writer').click(function() {
                        $('#noteSend_Window').show()
                     });
                     // íŠ¹ì • ì°½ ì œì™¸í•˜ê³  ë‚˜ë¨¸ì§€ ìš”ì†Œë¥¼ í´ë¦­í•  ì‹œ ì°½ ìˆ¨ê¸°ê¸°
                     $(document).click(function(event) {
                            // ê¸€ ì‘ì„±ì ë”ë³´ê¸° ë©”ë‰´ì°½ ìì‹ ìš”ì†Œ / ê¸€ ì‘ì„±ìë¥¼ ì œì™¸í•œ ì¢Œí‘œë¥¼ í´ë¦­ì‹œ ë”ë³´ê¸° ë©”ë‰´ì°½ ìˆ¨ê¸°ê¸°
                            if (!$('#noteSend_Window').has(event.target).length && !$('#article_addtext_writer').is(event.target)) {
                                  $('#noteSend_Window').hide();
                            }
                     });
                     // ìª½ì§€ ë³´ë‚´ê¸° í´ë¦­ì‹œ
                     $('#open-message-btn').click(function() {
                          // ìª½ì§€ ë³´ë‚´ê¸° ì°½ ì—´ê¸°
                          window.open('/notes/new?id=' + [[${article.member.email}]], 'ìª½ì§€ ë³´ë‚´ê¸°', 'width=400,height=420,resizable=no');
                     });
                });

                 // ì‚­ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥¼ì‹œ ì˜ˆ/ì•„ë‹ˆì˜¤ íŒì—…ì°½
                 function articleDelete() {
                        modal.show();
                 }
                 // ê¸€ ì‚­ì œ
                 function articleDeleteYes(articleId) {
                     $.ajax({
                        ã€€ã€€type:'delete'
                        ã€€ã€€, contentType:'application/json'
                        ã€€ã€€, url: '/api/articles/' + articleId
                        ã€€ã€€, success: function(data) {
                                 // ì˜ˆ/ì•„ë‹ˆì˜¤ íŒì—…ì°½ ìˆ¨ê¸°ê¸°
                                 modal.hide();
                                 alert(data.message);
                                 location.href='/';
                        ã€€ã€€}
                           , beforeSend : function(xhr) {
                                      xhr.setRequestHeader(header, token);
                           }
                           , error:function(e) {
                                alert(e.responseJSON.message);
                        ã€€ã€€}
                        });
                 }
                 // ì•„ë‹ˆìš” ë²„íŠ¼ì„ ëˆ„ë¥¼ì‹œ íŒì—…ì°½ ë‹«ê¸°
                 function articleDeleteNo() {
                         modal.hide();
                 }
                 // ëŒ“ê¸€ ì‘ì„±
                 function commentSubmit(articleId) {
                         var obj = {};
                         obj.content = $("#content").val()
                         obj.boardid = articleId
                         $.ajax({
                                ã€€ã€€type:'post'
                                ã€€ã€€, contentType:'application/json'
                                ã€€ã€€, data: JSON.stringify(obj)
                                ã€€ã€€, url: '/api/comments'
                                ã€€ã€€, success: function(data) {
                                        window.location.href = '/articles/' + articleId;
                                ã€€ã€€}
                                   , beforeSend : function(xhr) {
                                      xhr.setRequestHeader(header, token);
                                   }
                                   , error:function(e) {
                                        alert(e.responseJSON.message);
                                ã€€ã€€}
                         });
                }
                // ëŒ“ê¸€/ëŒ€ëŒ“ê¸€ ìˆ˜ì •
                function updateComment(commentId,content) {
                         var obj = {};
                         obj.content = content;
                         obj.id = commentId;
                   $.ajax({
                        ã€€ã€€type:'patch'
                        ã€€ã€€, contentType:'application/json'
                           , data: JSON.stringify(obj)
                        ã€€ã€€, url: '/api/comments'
                        ã€€ã€€, success: function(data) {
                                 window.location.href = '/articles/' + articleId;
                        ã€€ã€€}
                           , beforeSend : function(xhr) {
                                 xhr.setRequestHeader(header, token);
                           }
                           , error:function(e) {
                                 alert(e.responseJSON.message);
                        ã€€ã€€}
                        });
                };
                // ëŒ“ê¸€/ëŒ€ëŒ“ê¸€ ì‚­ì œ
                function deleteComment(commentId) {
                   $.ajax({
                        ã€€ã€€type:'delete'
                        ã€€ã€€, contentType:'application/json'
                        ã€€ã€€, url: '/api/comments/' + commentId
                        ã€€ã€€, success: function(data) {
                                 window.location.href = '/articles/' + articleId;
                        ã€€ã€€}
                           , beforeSend : function(xhr) {
                                 xhr.setRequestHeader(header, token);
                           }
                           , error:function(e) {
                                 alert(e.responseJSON.message);
                        ã€€ã€€}
                        });
                };
                // ë‹µê¸€ ë‹¬ê¸° ë²„íŠ¼ì„ ëˆ„ë¥¼ì‹œ ëŒ€ëŒ“ê¸€ form ë„ìš°ê¸°
                function replyButton(commentId) {
                         const replyform = document.getElementById('reply_form_' + commentId);
                         if (replyform.style.display == "block") {
                               replyform.style.display = 'none';
                         }
                         else{
                           replyform.style.display = 'block';
                         }
                }
                // ëŒ€ëŒ“ê¸€ ì‘ì„±
                function replySubmit(articleId,parentid) {

                     var obj = {};
                     obj.content = $('#reply_content' + parentid).val()
                     obj.boardid = articleId
                     obj.parentid = parentid;

                     $.ajax({
                            ã€€ã€€type:'post'
                            ã€€ã€€, contentType:'application/json'
                            ã€€ã€€, data: JSON.stringify(obj)
                            ã€€ã€€, url: '/api/comments/replies'
                            ã€€ã€€, success: function(data) {
                                    window.location.href = '/articles/' + articleId;
                            ã€€ã€€}
                                , beforeSend : function(xhr) {
                                     xhr.setRequestHeader(header, token);
                                }
                               , error:function(e) {
                                    alert(e.responseJSON.message);
                            ã€€ã€€}
                            });
                }

    </script>
</th:block>
</html>
