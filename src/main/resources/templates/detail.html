<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.w3.org/1999/xhtml" layout:decorate="layout/default_layout">
<th:block layout:fragment="content">
    <div class="modal">
        <div class="modal_popup">
            <h5> ì‚­ì œë¥¼ ì›í•˜ì‹œë©´ ì˜ˆë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”. </h5></br>
            <button type="button" onclick="articleDeleteYes(this.getAttribute('data-article-id'))" th:attr="data-article-id=${article.id}" class="close_btn">ì˜ˆ</button>
            <button type="button" onclick="articleDeleteNo()" class="close_btn">ì•„ë‹ˆìš”</button>
        </div>
    </div>
    <div class="article_button" sec:authorize="isAuthenticated()">
        <button th:if="${article.member.id == @authenticationUtil.getCurrentMember()?.id}" class="button_blue" th:onclick="|location.href='@{/article/update/{id}(id=${article.id})}'|">ìˆ˜ì •í•˜ê¸°</button>
        <button th:if="${article.member.id == @authenticationUtil.getCurrentMember()?.id}" onclick="articleDelete()" class="button_red" >ì‚­ì œí•˜ê¸°</button>
    </div>
    <div class="article">
            <h2 class="bold" th:text="${article.title}" >
            </h2><br>
        <div class="detail_content_area" th:text="${article.content}"></div></br>
        <span class="article_addtext bold" th:text="${article.member.usernick}"></span>
        <span> Â· </span>
        <span class="article_addtext" th:text="${@timeUtil.calculateTimeAgo(article.createdDate)}"></span>
        <span> Â· </span>
        <span class="article_addtext" th:text="${article.viewcount}"></span></br>
    </div>

    <div class="article_images" th:if="${article.imageUrls.size() != 0}">
        <label class="form-label">ì´ë¯¸ì§€</label>
        <div th:each="imageUrl : ${article.imageUrls}">
            <img th:src="@{${imageUrl}}" width="200px" height="200px">
        </div>
    </div>
    <div class="comment_count ">
        ğŸ’¬ ëŒ“ê¸€
        <b class="bold" th:text="${comment.getTotalElements()}"></b>
        ê°œ
    </div>

    <div th:if="${endPage != 0}" th:each="comment : ${comment}" class="article_comments">

        <div th:if="${comment.deleted == false}">
            <span class="bold" th:text="${comment.member.usernick}"></span>
            <span> Â· </span>
            <span th:text="${@timeUtil.calculateTimeAgo(comment.createdDate)}"></span>
            <span> Â· </span>
            <span sec:authorize="isAuthenticated()" class="comment_delete">
                <button onclick="deleteComment(this.getAttribute('data-comment-id'))" th:attr="data-comment-id=${comment.id}" th:if="${comment.member.id == @authenticationUtil.getCurrentMember()?.id}">ì‚­ì œ</button>
            </span><br><br>

            <div th:text="${comment.content}"></div>

            <!-- ë‹µê¸€ ë‹¬ê¸° ë²„íŠ¼ -->
            <div th:if="${comment.child.size() <= 10}">
                <button class="reply_button" th:id="'reply_button_' + ${comment.id}" onclick="replyButton(this.getAttribute('data-comment-id'))" th:attr="data-comment-id=${comment.id}">ë‹µê¸€ ë‹¬ê¸°</button>
            </div>
        </div>
        <div th:unless="${comment.deleted == false}">
            <div> ì‚­ì œëœ ëŒ“ê¸€ ì…ë‹ˆë‹¤!</div>
        </div>
        <!-- ìì‹ ëŒ“ê¸€ë“¤ ì¶œë ¥ -->
        <div th:if="${comment.child != null}">
            <div th:each="child : ${comment.child}">
                <div class="reply_comments">
                    <span class="bold" th:text="${comment.member.usernick}"></span>
                    <span> Â· </span>
                    <span th:text="${@timeUtil.calculateTimeAgo(child.createdDate)}"></span>
                    <span> Â· </span>
                    <span sec:authorize="isAuthenticated()" class="comment_delete">
                        <button onclick="deleteReply(this.getAttribute('data-child-id'))" th:attr="data-child-id=${child.id}" th:if="${comment.member.id == @authenticationUtil.getCurrentMember()?.id}">ì‚­ì œ</button>
                    </span><br><br>
                <div style="display:flex">
                    <span style="color:#6c757d; margin:0 10px;" th:text="${child.comment.member.usernick}"> </span>
                    <div th:text="${child.content}"></div>
                </div>
                </div>
            </div>
        </div>

        <div class="reply-form" th:id="'reply_form_' + ${comment.id}" style="display: none;">
            <div class="comment_write">
                <h2>ë‹µê¸€ì“°ê¸°</h2>
                <div sec:authorize="isAuthenticated()">
                    <textarea type="text" th:id="'reply_content' + ${comment.id}" ></textarea>
                    <button onclick="replySubmit(this.getAttribute('data-comment-id'))" th:attr="data-comment-id=${comment.id}" class="reply-submit">ë“±ë¡</button>
                </div>
                <div sec:authorize="isAnonymous()" class="disabled">
                    <textarea type="text" >ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”</textarea>
                    <button >ë“±ë¡</button>
                </div>
            </div>
        </div>

    </div>

    <div th:if="${endPage != 0}" class="paging_list">
        <a class="page_previous" th:classappend=" ${!comment.hasPrevious()} ? 'disabled' " th:href="${!comment.isFirst()} ? @{/article/detail/{id}(id=${article.id},page=${comment.getPageable().getPageNumber()})}"> ì´ì „ </a>

        <span th:each="page: ${#numbers.sequence(startPage, endPage)}">
		<!-- í˜„ì¬í˜ì´ì§€ëŠ” ë§í¬ ì—†ì´ ìˆ«ìë§Œ -->
            <span th:if="${page == comment.getPageable().getPageNumber() + 1}" th:text="${page}"></span>
            <!-- í˜„ì¬í˜ì´ì§€ ë§í¬ X, ë‹¤ë¥¸ í˜ì´ì§€ë²ˆí˜¸ì—ëŠ” ë§í¬ë¥¼ ë³´ì—¬ì¤€ë‹¤ -->
            <span th:unless="${page == comment.getPageable().getPageNumber() + 1}">
        <a th:href="@{/article/detail/{id}(id=${article.id},page=${page})}" th:text="${page}"></a>
            </span>
        </span>
        <!-- ë‹¤ìŒ ë§í¬ í™œì„±í™” ë¹„í™œì„±í™” -->
        <a class="page_next" th:classappend=" ${!comment.hasNext()} ? 'disabled' "  th:href="${comment.isLast()} ? '#' : @{/article/detail/{id}(id=${article.id},page=${comment.number + 2})}"> ë‹¤ìŒ </a>
    </div>
    <div class="comment_write">
            <h2>ëŒ“ê¸€ì“°ê¸°</h2>
            <div sec:authorize="isAuthenticated()">
                <textarea type="text" id="content" ></textarea>
                <button onclick="commentSubmit(this.getAttribute('data-article-id'))" th:attr="data-article-id=${article.id}" >ë“±ë¡</button>
            </div>
           <div sec:authorize="isAnonymous()" class="disabled">
            <textarea type="text" >ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”</textarea>
            <button >ë“±ë¡</button>
           </div>

    </div>

    <script th:inline="javascript">

                 const modal = document.querySelector('.modal');
                 function articleDelete() {
                        modal.style.display = 'block';
                 }

                 function articleDeleteYes(articleId) {
                     var obj = {};
                     obj.id = articleId
                     $.ajax({
                        ã€€ã€€type:'delete'
                        ã€€ã€€, contentType:'application/json'
                        ã€€ã€€, data: JSON.stringify(obj)
                        ã€€ã€€, url: '/article/delete'
                        ã€€ã€€, success: function(data) {
                                 modal.style.display = 'none';
                                 location.href='/';
                        ã€€ã€€}, error:function(e) {
                                console.log(e);
                        ã€€ã€€}
                        });
                 }

                 function articleDeleteNo() {
                         modal.style.display = 'none';
                 }

                 function commentSubmit(articleId) {
                         var obj = {};
                         obj.content = $("#content").val()
                         obj.boardid = articleId
                         $.ajax({
                                ã€€ã€€type:'post'
                                ã€€ã€€, contentType:'application/json'
                                ã€€ã€€, data: JSON.stringify(obj)
                                ã€€ã€€, url: '/comment/write'
                                ã€€ã€€, success: function(data) {
                                       window.location.href = '/article/detail/' + articleId;
                                ã€€ã€€}, error:function(e) {
                                    var jsonResponse = JSON.parse(e.responseText);
                                    if (jsonResponse.hasOwnProperty('content')) {
                                    alert(jsonResponse.content);
                                    }
                                ã€€ã€€}
                         });
                }

                function deleteComment(commentId) {

                   var obj = {};
                   obj.id = commentId;

                   $.ajax({
                        ã€€ã€€type:'delete'
                        ã€€ã€€, contentType:'application/json'
                        ã€€ã€€, data: JSON.stringify(obj)
                        ã€€ã€€, url: '/comment/delete'
                        ã€€ã€€, success: function(data) {
                                 window.location.href = '/article/detail/' + [[${article.id}]];
                        ã€€ã€€}, error:function(e) {
                                console.log(e);
                        ã€€ã€€}
                        });
                 };

                function replyButton(commentId) {
                         const replyform = document.getElementById('reply_form_' + commentId);
                         if (replyform.style.display == "block") {
                               replyform.style.display = 'none';
                         }
                         else{
                           replyform.style.display = 'block';
                         }
                }

                function replySubmit(commentId) {

                     var obj = {};
                     obj.content = $('#reply_content' + commentId).val()
                     obj.commentid = commentId

                     $.ajax({
                            ã€€ã€€type:'post'
                            ã€€ã€€, contentType:'application/json'
                            ã€€ã€€, data: JSON.stringify(obj)
                            ã€€ã€€, url: '/reply/write'
                            ã€€ã€€, success: function(data) {
                                    window.location.href = '/article/detail/' + [[${article.id}]];
                            ã€€ã€€}, error:function(e) {
                                 var jsonResponse = JSON.parse(e.responseText);
                                if (jsonResponse.hasOwnProperty('content')) {
                                alert(jsonResponse.content);
                                }
                            ã€€ã€€}
                            });
                }

                function deleteReply(replyId) {
                       var obj = {};
                       obj.id = replyId;

                       $.ajax({
                            ã€€ã€€type:'delete'
                            ã€€ã€€, contentType:'application/json'
                            ã€€ã€€, data: JSON.stringify(obj)
                            ã€€ã€€, url: '/reply/delete'
                            ã€€ã€€, success: function(data) {
                                     window.location.href = '/article/detail/' + [[${article.id}]];
                            ã€€ã€€}, error:function(e) {
                                    console.log(e);
                            ã€€ã€€}
                            });
                };
    </script>
</th:block>
</html>
